generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StaffStatus {
  ACTIVE
  INACTIVE
  INVITED
  LEAVE
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum DepositType {
  NONE
  FIXED
  PERCENTAGE
}

enum ResourceType {
  CHAIR
  BASIN
  ROOM
  EQUIPMENT
  GENERIC
}

enum ScheduleOwnerType {
  LOCATION
  STAFF
  RESOURCE
}

enum ScheduleRuleType {
  WEEKLY
  DATE
}

enum Weekday {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum AvailabilityExceptionType {
  BLOCK
  OPEN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentPaymentStatus {
  UNPAID
  AUTHORIZED
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
}

enum AppointmentSource {
  WEB
  ADMIN
  API
  IMPORT
}

enum AppointmentItemStatus {
  PENDING
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum PolicyType {
  CANCELLATION
  NO_SHOW
  DEPOSIT
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationTrigger {
  BOOKING_CONFIRMATION
  APPOINTMENT_REMINDER
  NO_SHOW_FOLLOW_UP
  CUSTOM
}

enum NotificationStatus {
  PENDING
  SCHEDULED
  SENT
  FAILED
  CANCELLED
}

enum AuditActorType {
  SYSTEM
  USER
  CUSTOMER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ACCESS
}

enum ConsentType {
  COMMUNICATION
  MARKETING
  TERMS
  PRIVACY
}

enum ConsentScope {
  EMAIL
  SMS
  WHATSAPP
  PHONE
  PUSH
}

enum ConsentSource {
  WEB
  ADMIN
  IMPORT
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

model Tenant {
  id        String     @id @default(cuid())
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  locations Location[]
}

model Location {
  id           String       @id @default(cuid())
  tenantId     String       @default("legacy")
  slug         String
  name         String
  stundenlisteBranchId Int?
  timezone     String
  email        String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  currency     String       @default("EUR")
  metadata     Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  staff                  Staff[]
  staffMemberships       StaffLocationMembership[]
  customers              Customer[]
  customerCategories     CustomerCategory[]
  customerMemberships    CustomerLocationMembership[]
  services               Service[]
  serviceCategories      ServiceCategory[]
  resources              Resource[]
  schedules              Schedule[]
  appointments           Appointment[]
  policies               Policy[]
  notifications          Notification[]
  availabilityExceptions AvailabilityException[]
  timeOffs               TimeOff[]
  auditLogs              AuditLog[]
  consents               Consent[]
  customerDeviceVerifications CustomerDeviceVerification[]
  customerStaffBookingPermissions CustomerStaffBookingPermission[]
  customerPermissionTokens CustomerPermissionToken[]

  @@index([timezone])
  @@index([country, city])
  @@index([tenantId])
  @@unique([tenantId, stundenlisteBranchId])
  @@unique([tenantId, slug])
}

model Staff {
  id           String       @id @default(cuid())
  locationId   String
  userId       String?      @unique
  code         String?
  firstName    String
  lastName     String
  displayName  String?
  email        String?
  phone        String?
  color        String?
  status       StaffStatus  @default(ACTIVE)
  bio          String?
  bookingPin   String?
  metadata     Json?
  calendarOrder Int?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  schedules              Schedule[]
  timeOffs               TimeOff[]
  availabilityExceptions AvailabilityException[]
  appointmentItems       AppointmentItem[]
  notifications          Notification[]
  scheduleRules          ScheduleRule[]
  memberships            StaffLocationMembership[]
  customerBookingPermissions CustomerStaffBookingPermission[]

  @@index([locationId, status])
  @@unique([locationId, code])
}

model Customer {
  id         String    @id @default(cuid())
  locationId String
  categoryId String?
  email      String?
  phone      String?
  firstName  String
  lastName   String
  notes      String?
  metadata   Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  category CustomerCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  appointments   Appointment[]
  appointmentFor AppointmentItem[]
  notifications  Notification[]
  consents       Consent[]
  memberships    CustomerLocationMembership[]
  devices        CustomerDevice[]
  deviceVerifications CustomerDeviceVerification[]
  staffBookingPermissions CustomerStaffBookingPermission[]
  permissionTokens CustomerPermissionToken[]

  @@index([locationId, email])
  @@index([locationId, phone])
  @@index([categoryId])
}

model CustomerDevice {
  id          String   @id @default(cuid())
  customerId  String
  deviceId    String
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  userAgent   String?
  revokedAt   DateTime?

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, deviceId])
  @@index([deviceId])
  @@index([customerId])
}

model CustomerDeviceVerification {
  id         String   @id @default(cuid())
  customerId String
  locationId String
  deviceId   String
  verifiedAt DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([customerId, locationId, deviceId])
  @@index([deviceId])
  @@index([customerId])
  @@index([locationId])
}

model CustomerStaffBookingPermission {
  id               String   @id @default(cuid())
  customerId       String
  locationId       String
  staffId          String
  isAllowed        Boolean  @default(true)
  grantedAt        DateTime @default(now())
  grantedByUserId  String?
  revokedAt        DateTime?
  revokedByUserId  String?

  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  location  Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  grantedBy User?    @relation("CustomerStaffPermissionGrantedBy", fields: [grantedByUserId], references: [id], onDelete: SetNull)
  revokedBy User?    @relation("CustomerStaffPermissionRevokedBy", fields: [revokedByUserId], references: [id], onDelete: SetNull)

  @@unique([customerId, locationId, staffId])
  @@index([customerId])
  @@index([locationId])
  @@index([staffId])
}

model CustomerPermissionToken {
  id              String   @id @default(cuid())
  tokenHash       String   @unique
  customerId      String
  locationId      String
  expiresAt       DateTime
  usedAt          DateTime?
  createdAt       DateTime @default(now())
  createdByUserId String?

  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  location  Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  createdBy User?    @relation("CustomerPermissionTokenCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([locationId])
}

model CustomerCategory {
  id          String   @id @default(cuid())
  locationId  String
  name        String
  slug        String
  description String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  customers Customer[]

  @@unique([locationId, slug])
  @@index([locationId])
}

model StaffLocationMembership {
  staffId    String
  locationId String
  role       String?    @db.VarChar(120)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  staff    Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@id([staffId, locationId])
  @@index([locationId])
}

model CustomerLocationMembership {
  customerId String
  locationId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  location Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@id([customerId, locationId])
  @@index([locationId])
}

model Service {
  id            String        @id @default(cuid())
  locationId    String
  categoryId    String?
  name          String
  slug          String
  description   String?
  color         String?
  duration      Int            // duration minutes
  bufferBefore  Int            @default(0)
  bufferAfter   Int            @default(0)
  basePrice     Decimal        @db.Decimal(10, 2)
  priceCurrency String         @default("EUR")
  depositType   DepositType    @default(NONE)
  depositAmount Decimal?       @db.Decimal(10, 2)
  status        ServiceStatus  @default(ACTIVE)
  maxParticipants Int          @default(1)
  metadata      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  category ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  steps            ServiceStep[]
  appointmentItems AppointmentItem[]
  scheduleRules    ScheduleRule[]

  @@unique([locationId, slug])
  @@index([locationId, status])
  @@index([categoryId])
}

model ServiceCategory {
  id          String   @id @default(cuid())
  locationId  String
  name        String
  slug        String
  description String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  services Service[]

  @@unique([locationId, slug])
  @@index([locationId])
}

model ServiceStep {
  id                       String                @id @default(cuid())
  serviceId                String
  name                     String
  description              String?
  order                    Int
  duration                 Int
  minStaff                 Int                   @default(1)
  maxStaff                 Int                   @default(1)
  requiresExclusiveResource Boolean              @default(false)
  metadata                 Json?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  resources       ServiceStepResource[]
  appointmentItems AppointmentItem[]

  @@index([serviceId, order])
}

model Resource {
  id         String       @id @default(cuid())
  locationId String
  name       String
  code       String?
  type       ResourceType @default(GENERIC)
  capacity   Int          @default(1)
  color      String?
  isActive   Boolean      @default(true)
  metadata   Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  serviceStepLinks      ServiceStepResource[]
  schedules             Schedule[]
  availabilityExceptions AvailabilityException[]
  appointmentItems      AppointmentItem[]

  @@unique([locationId, name])
  @@unique([locationId, code])
  @@index([locationId, type])
}

model ServiceStepResource {
  id            String       @id @default(cuid())
  serviceStepId String
  resourceId    String
  quantity      Int          @default(1)

  serviceStep ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)
  resource    Resource    @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([serviceStepId, resourceId])
}

model Schedule {
  id         String             @id @default(cuid())
  locationId String
  ownerType  ScheduleOwnerType
  staffId    String?
  resourceId String?
  name       String
  timezone   String
  isDefault  Boolean            @default(false)
  metadata   Json?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  staff    Staff?   @relation(fields: [staffId], references: [id], onDelete: SetNull)
  resource Resource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  rules                 ScheduleRule[]
  timeOffs              TimeOff[]
  availabilityExceptions AvailabilityException[]
  appointments          Appointment[]

  @@index([locationId, ownerType])
}

model ScheduleRule {
  id          String            @id @default(cuid())
  scheduleId  String
  ruleType    ScheduleRuleType  @default(WEEKLY)
  weekday     Weekday?
  startsAt    Int                // minutes since midnight
  endsAt      Int
  serviceId   String?
  staffId     String?
  priority    Int                @default(0)
  effectiveFrom DateTime?
  effectiveTo DateTime?
  isActive    Boolean            @default(true)
  metadata    Json?

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  service  Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  staff    Staff?   @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@index([scheduleId, ruleType, weekday])
}

model TimeOff {
  id          String    @id @default(cuid())
  locationId  String
  scheduleId  String?
  staffId     String?
  reason      String?
  startsAt    DateTime
  endsAt      DateTime
  createdById String?
  metadata    Json?
  createdAt   DateTime  @default(now())

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  schedule Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  staff    Staff?    @relation(fields: [staffId], references: [id], onDelete: SetNull)
  createdBy User?     @relation("TimeOffCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
}

model AvailabilityException {
  id          String                   @id @default(cuid())
  locationId  String
  scheduleId  String?
  staffId     String?
  resourceId  String?
  startsAt    DateTime
  endsAt      DateTime
  type        AvailabilityExceptionType @default(BLOCK)
  reason      String?
  createdById String?
  metadata    Json?
  createdAt   DateTime @default(now())

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  schedule Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  staff    Staff?    @relation(fields: [staffId], references: [id], onDelete: SetNull)
  resource Resource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)
  createdBy User?     @relation("AvailabilityExceptionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([locationId, startsAt])
}

model Appointment {
  id             String                  @id @default(cuid())
  locationId     String
  customerId     String?
  scheduleId     String?
  confirmationCode String                @unique
  idempotencyKey String?
  status         AppointmentStatus       @default(PENDING)
  paymentStatus  AppointmentPaymentStatus @default(UNPAID)
  source         AppointmentSource       @default(WEB)
  startsAt       DateTime
  endsAt         DateTime
  totalAmount    Decimal                 @db.Decimal(10, 2)
  depositAmount  Decimal?                @db.Decimal(10, 2)
  currency       String                  @default("EUR")
  note           String?
  cancelReason   String?
  cancelledAt    DateTime?
  createdById    String?
  metadata       Json?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  schedule Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  createdBy User?     @relation("AppointmentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  items         AppointmentItem[]
  notifications Notification[]
  auditLogs     AuditLog[]
  attachments   AppointmentAttachment[]
  accessTokens  AppointmentAccessToken[]

  @@index([locationId, startsAt])
  @@index([status])
  @@unique([locationId, idempotencyKey])
}

model BookingSlotClaim {
  id             String   @id @default(cuid())
  locationId     String
  slotKey        String
  idempotencyKey String?
  status         String
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([locationId, slotKey])
  @@index([expiresAt])
  @@index([locationId])
}

model ActionCenterNonce {
  id        String   @id @default(cuid())
  nonce     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model AppointmentAccessToken {
  id            String   @id @default(cuid())
  appointmentId String
  tokenHash     String   @unique
  shortCodeHash String?  @unique
  expiresAt     DateTime
  revokedAt     DateTime?
  createdAt     DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([expiresAt])
}

model AppointmentItem {
  id            String               @id @default(cuid())
  appointmentId String
  serviceId     String
  serviceStepId String?
  customerId    String?
  staffId       String?
  resourceId    String?
  status        AppointmentItemStatus @default(PENDING)
  startsAt      DateTime
  endsAt        DateTime
  price         Decimal               @db.Decimal(10, 2)
  currency      String                @default("EUR")
  notes         String?
  metadata      Json?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  serviceStep ServiceStep? @relation(fields: [serviceStepId], references: [id], onDelete: SetNull)
  customer    Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  staff       Staff?      @relation(fields: [staffId], references: [id], onDelete: SetNull)
  resource    Resource?   @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  @@index([appointmentId, startsAt])
  @@index([staffId, startsAt])
}

model AppointmentAttachment {
  id            String      @id @default(cuid())
  appointmentId String
  locationId    String
  fileName      String
  mimeType      String
  size          Int
  data          Bytes?
  createdAt     DateTime    @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

model Policy {
  id          String     @id @default(cuid())
  locationId  String
  type        PolicyType
  name        String
  description String?
  isActive    Boolean    @default(true)
  configuration Json
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, type])
}

model Notification {
  id            String              @id @default(cuid())
  locationId    String
  appointmentId String?
  customerId    String?
  staffId       String?
  channel       NotificationChannel
  trigger       NotificationTrigger
  status        NotificationStatus  @default(PENDING)
  scheduledAt   DateTime?
  sentAt        DateTime?
  payload       Json?
  error         String?
  metadata      Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  location    Location    @relation(fields: [locationId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  customer    Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  staff       Staff?       @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@index([locationId, channel, status])
}

model AuditLog {
  id           String         @id @default(cuid())
  locationId   String?
  actorId      String?
  appointmentId String?
  actorType    AuditActorType
  action       AuditAction
  entityType   String
  entityId     String
  diff         Json?
  context      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime       @default(now())

  location    Location?    @relation(fields: [locationId], references: [id], onDelete: SetNull)
  actor       User?        @relation(fields: [actorId], references: [id], onDelete: SetNull)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
}

model Consent {
  id           String        @id @default(cuid())
  customerId   String
  locationId   String
  type         ConsentType
  scope        ConsentScope
  granted      Boolean
  grantedAt    DateTime
  expiresAt    DateTime?
  revokedAt    DateTime?
  source       ConsentSource @default(WEB)
  recordedById String?
  metadata     Json?

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  recordedBy User?    @relation(fields: [recordedById], references: [id], onDelete: SetNull)

  @@unique([customerId, type, scope])
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  emailVerified  DateTime?
  hashedPassword String?
  role           UserRole       @default(ADMIN)
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  staff        Staff?
  oauthAccounts OAuthAccount[]
  auditLogs    AuditLog[]
  createdTimeOffs TimeOff[]     @relation("TimeOffCreatedBy")
  createdAvailabilityExceptions AvailabilityException[] @relation("AvailabilityExceptionCreatedBy")
  createdAppointments Appointment[] @relation("AppointmentCreatedBy")
  recordedConsents Consent[]
  grantedCustomerStaffPermissions CustomerStaffBookingPermission[] @relation("CustomerStaffPermissionGrantedBy")
  revokedCustomerStaffPermissions CustomerStaffBookingPermission[] @relation("CustomerStaffPermissionRevokedBy")
  createdCustomerPermissionTokens CustomerPermissionToken[] @relation("CustomerPermissionTokenCreatedBy")
}

model OAuthAccount {
  id                String   @id @default(cuid())
  userId            String
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  tokenType         String?
  scope             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}
